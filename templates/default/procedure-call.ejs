<%
const { utils, route, config } = it;
const { requestBodyInfo, responseBodyInfo, specificArgNameResolver } = route;
const { _, getInlineParseContent, getParseContent, parseSchema, getComponentByRef, require } = utils;
const { parameters, path, method, payload, query, formData, security, requestParams } = route.request;
const { type, errorType, contentTypes } = route.response;
const { HTTP_CLIENT, RESERVED_REQ_PARAMS_ARG_NAMES } = config.constants;
const routeDocs = includeFile("@base/route-docs", { config, route, utils });
const queryName = (query && query.name) || "query";
const pathParams = _.values(parameters);
const pathParamsNames = _.map(pathParams, "name");

const isFetchTemplate = config.httpClientType === HTTP_CLIENT.FETCH;

const requestConfigParam = {
    name: specificArgNameResolver.resolve(RESERVED_REQ_PARAMS_ARG_NAMES),
    optional: true,
    type: "RequestParams",
    defaultValue: "{}",
}

const argToTmpl = ({ name, optional, type, defaultValue }) => `${name}${!defaultValue && optional ? '?' : ''}: ${type}${defaultValue ? ` = ${defaultValue}` : ''}`;

const rawWrapperArgs = config.extractRequestParams ?
    _.compact([
        requestParams && {
          name: pathParams.length ? `{ ${_.join(pathParamsNames, ", ")}, ...${queryName} }` : queryName,
          optional: false,
          type: getInlineParseContent(requestParams),
        },
        ...(!requestParams ? pathParams : []),
        payload
    ]) :
    _.compact([
        ...pathParams,
        query,
        payload
    ])

const wrapperArgs = _
    // Sort by optionality
    .sortBy(rawWrapperArgs, [o => o.optional])
    .map(argToTmpl)
    .join(', ')

const bodyTmpl = _.get(payload, "name") || null;
const queryTmpl = (query != null && queryName) || null;
const securityTmpl = !!security;

const isValidIdentifier = (name) => /^[A-Za-z_$][A-Za-z0-9_$]*$/.test(name);

%>
/**
<%~ routeDocs.description %>
<%~ routeDocs.lines %>
*/
<%
const hasPathParams = pathParams.length > 0;
const hasPayload = !!payload;
%>

<%= route.routeName.usage %>: (
  <% if (hasPathParams) { %><%= pathParams.map(p => p.name).join(', ') %><% } %>
  <% if (hasPathParams && hasPayload) { %>, <% } %>
  <% if (hasPayload) { %><%= payload.name %><% } %>
): Promise<<%= type %>> =>
  $<%= method %><<%= type %>>(`<%= path %>`, {
    <% if (hasPayload) { %>data: <%= payload.name %>,<% } %>
    isBearer: <%= security ? 'true' : 'false' %>
  }),

<%= route.routeName.usage %>Async: (
  <% if (hasPathParams) { %>{ <%= pathParams.map(p => p.name).join(', ') %> }<% } %>
  <% if (hasPathParams) { %>, <% } %>
  opts?: CustomFetchOptions<<%= type %>>
) =>
  customUseFetch<<%= type %>>(`<%= path %>`, '<%= method %>', {
    ...opts,
    isBearer: <%= security ? 'true' : 'false' %>
  }),
